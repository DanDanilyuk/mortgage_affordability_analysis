<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Affordability Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .update-info {
            margin-top: 10px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .content {
            padding: 40px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .info-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: relative;
        }

        .info-card.estimated {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px dashed #f39c12;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
        }

        .estimated-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f39c12;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-info {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 0.95em;
            color: #856404;
        }

        .legend-info strong {
            color: #f39c12;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .date-range-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .date-range-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .date-range-header h3 {
            color: #667eea;
            font-size: 1.2em;
        }

        .date-range-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }

        .zoom-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.85em;
            color: #1565c0;
        }

        .methodology {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .methodology h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .methodology p {
            line-height: 1.8;
            color: #555;
            margin-bottom: 10px;
        }

        .methodology ul {
            margin-left: 20px;
            line-height: 1.8;
            color: #555;
        }

        .error-message {
            background: #fee;
            border: 2px solid #c33;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        footer {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Mortgage Affordability Analysis</h1>
            <p class="subtitle">Cost-to-Income Multiplier Over Time</p>
            <p class="update-info" id="updateInfo">Loading data...</p>
        </header>

        <div class="content">
            <div id="loadingMessage" class="loading">
                Loading mortgage affordability data...
            </div>

            <div id="mainContent" style="display: none;">
                <div id="estimationWarning" class="legend-info" style="display: none;">
                    <strong>ðŸ“Š Note:</strong> Dashed lines and shaded areas represent <strong>estimated values</strong>
                    based on seasonal adjustment factors. Solid lines show actual reported data.
                </div>

                <div class="info-grid" id="infoGrid">
                    <div class="info-card" id="multiplierCard">
                        <div class="info-label">Current Multiplier</div>
                        <div class="info-value" id="currentMultiplier">-</div>
                    </div>
                    <div class="info-card" id="priceCard">
                        <div class="info-label">House Price</div>
                        <div class="info-value" id="housePrice">-</div>
                    </div>
                    <div class="info-card" id="incomeCard">
                        <div class="info-label">Annual Income</div>
                        <div class="info-value" id="annualIncome">-</div>
                    </div>
                    <div class="info-card" id="rateCard">
                        <div class="info-label">Mortgage Rate</div>
                        <div class="info-value" id="mortgageRate">-</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary active" onclick="showBothLines()">Both</button>
                    <button class="btn btn-secondary" onclick="showSingleOnly()">Single Income</button>
                    <button class="btn btn-secondary" onclick="showHouseholdOnly()">Household Income (1.4x)</button>
                </div>

                <div class="date-range-controls">
                    <div class="date-range-header">
                        <h3>ðŸ“… Date Range Selection</h3>
                        <button class="btn btn-secondary btn-small" onclick="resetZoom()">Reset Zoom</button>
                    </div>

                    <div class="date-range-buttons">
                        <button class="btn btn-secondary btn-small" onclick="setDateRange('1y')">Last Year</button>
                        <button class="btn btn-secondary btn-small" onclick="setDateRange('2y')">Last 2 Years</button>
                        <button class="btn btn-secondary btn-small" onclick="setDateRange('5y')">Last 5 Years</button>
                        <button class="btn btn-secondary btn-small" onclick="setDateRange('all')">All Data</button>
                    </div>

                    <div class="zoom-info">
                        ðŸ’¡ <strong>Tip:</strong> Scroll to zoom, or click and drag to pan the chart.
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="mortgageChart"></canvas>
                </div>

                <div class="methodology">
                    <h2>Methodology</h2>
                    <p><strong>Cost-to-Income Multiplier:</strong> This metric represents how many years of income it
                        would take to pay off a 30-year mortgage (including interest). A higher multiplier indicates
                        lower affordability.</p>
                    <p><strong>Data Sources:</strong></p>
                    <ul>
                        <li><strong>Average Weekly Earnings:</strong> BLS Series CES0500000011 (Average Weekly Earnings
                            of All Employees, Total Private)</li>
                        <li><strong>Case-Shiller Home Price Index:</strong> FRED Series CSUSHPINSA (S&P CoreLogic
                            Case-Shiller U.S. National Home Price Index)</li>
                        <li><strong>30-Year Mortgage Rates:</strong> FRED Series MORTGAGE30US (30-Year Fixed Rate
                            Mortgage Average)</li>
                    </ul>
                    <p><strong>Calculation:</strong> The multiplier is calculated as Total Mortgage Cost (principal +
                        interest over 30 years) divided by Annual Income. Annual income is derived from weekly earnings
                        Ã— 52 weeks.</p>
                    <p><strong>Household Income Assumption:</strong> Household income is calculated as 1.4x single
                        income to account for dual-income households, following standard affordability index
                        methodologies.</p>
                    <p><strong>Estimated Values:</strong> When official data is not yet available, values are estimated
                        using seasonal adjustment factors based on typical housing market patterns. Estimated values
                        appear as dashed lines on the chart.</p>
                </div>
            </div>
        </div>

        <footer>
            <p>Data analysis inspired by <a href="https://www.calculatedriskblog.com/p/weekly-schedule.html"
                    target="_blank">Calculated Risk</a> and <a
                    href="https://www.longtermtrends.net/home-price-median-annual-income-ratio/" target="_blank">Long
                    Term Trends</a></p>
            <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">Built with Chart.js | Data from BLS and FRED
                APIs | Made by <a href="https://www.dandanilyuk.com" target="_blank">Dan Danilyuk</a></p>
        </footer>
    </div>

    <script>
        // Global variables
        let chartData = null;
        let chartInstance = null;
        let firstEstimatedIndex = -1;
        let minDate = null;
        let maxDate = null;

        // Chart.js plugin to add background shading for estimated region
        const estimatedRegionPlugin = {
            id: 'estimatedRegion',
            beforeDraw: (chart) => {
                if (firstEstimatedIndex === -1) return;

                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const meta = chart.getDatasetMeta(0);

                if (!meta.data[firstEstimatedIndex]) return;

                const x = meta.data[firstEstimatedIndex].x;

                ctx.save();
                ctx.fillStyle = 'rgba(243, 156, 18, 0.08)';
                ctx.fillRect(x, chartArea.top, chartArea.right - x, chartArea.bottom - chartArea.top);
                ctx.restore();
            }
        };

        // Load data from the Ruby script output file
        fetch('weekly_case_shiller_output.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load data file. Please run the Ruby script first.');
                }
                return response.json();
            })
            .then(data => {
                chartData = data;

                // Find first estimated/interpolated index
                firstEstimatedIndex = chartData.single_costs.findIndex(item =>
                    item.estimated === true || item.interpolated === true
                );

                // Show estimation warning if we have estimated data
                if (firstEstimatedIndex !== -1) {
                    document.getElementById('estimationWarning').style.display = 'block';
                }

                // Set min/max dates
                minDate = new Date(chartData.single_costs[0].date);
                maxDate = new Date(chartData.single_costs[chartData.single_costs.length - 1].date);

                initializeChart();
                updateMetadata();
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML =
                    '<div class="error-message">' +
                    '<strong>Error Loading Data</strong><br>' +
                    error.message + '<br><br>' +
                    'Please ensure you have run the Ruby script to generate weekly_case_shiller_output.json' +
                    '</div>';
            });

        function updateMetadata() {
            if (chartData.metadata) {
                const generatedAt = new Date(chartData.metadata.generated_at);
                const dateStr = generatedAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const actualCount = firstEstimatedIndex === -1 ? chartData.single_costs.length : firstEstimatedIndex;
                const estimatedCount = firstEstimatedIndex === -1 ? 0 : chartData.single_costs.length - firstEstimatedIndex;

                let updateText = `Last updated: ${dateStr} | ${actualCount} actual`;
                if (estimatedCount > 0) {
                    updateText += ` + ${estimatedCount} estimated data points`;
                } else {
                    updateText += ` data points`;
                }

                document.getElementById('updateInfo').textContent = updateText;
            }
        }

        function initializeChart() {
            const ctx = document.getElementById('mortgageChart').getContext('2d');

            // Prepare data for Chart.js
            const labels = chartData.single_costs.map(item => item.date);
            const singleMultipliers = chartData.single_costs.map(item => item.cost_to_income);
            const householdMultipliers = chartData.household_costs.map(item => item.cost_to_income);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Single Income',
                            data: singleMultipliers,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: 'rgb(102, 126, 234)',
                            pointHoverBorderColor: 'white',
                            pointHoverBorderWidth: 3,
                            segment: {
                                borderDash: (ctx) => {
                                    const index = ctx.p1DataIndex;
                                    const dataPoint = chartData.single_costs[index];
                                    return (dataPoint.estimated || dataPoint.interpolated) ? [8, 4] : [];
                                },
                                borderColor: (ctx) => {
                                    const index = ctx.p1DataIndex;
                                    const dataPoint = chartData.single_costs[index];
                                    return (dataPoint.estimated || dataPoint.interpolated) ?
                                        'rgba(102, 126, 234, 0.7)' : 'rgb(102, 126, 234)';
                                }
                            }
                        },
                        {
                            label: 'Household Income (1.4x)',
                            data: householdMultipliers,
                            borderColor: 'rgb(118, 75, 162)',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: 'rgb(118, 75, 162)',
                            pointHoverBorderColor: 'white',
                            pointHoverBorderWidth: 3,
                            segment: {
                                borderDash: (ctx) => {
                                    const index = ctx.p1DataIndex;
                                    const dataPoint = chartData.household_costs[index];
                                    return (dataPoint.estimated || dataPoint.interpolated) ? [8, 4] : [];
                                },
                                borderColor: (ctx) => {
                                    const index = ctx.p1DataIndex;
                                    const dataPoint = chartData.household_costs[index];
                                    return (dataPoint.estimated || dataPoint.interpolated) ?
                                        'rgba(118, 75, 162, 0.7)' : 'rgb(118, 75, 162)';
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 15,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function (context) {
                                    const index = context[0].dataIndex;
                                    const singleData = chartData.single_costs[index];
                                    let title = 'Date: ' + context[0].label;

                                    if (singleData.estimated) {
                                        title += ' ðŸ”® (Estimated)';
                                    } else if (singleData.interpolated) {
                                        title += ' ðŸ“Š (Interpolated)';
                                    }

                                    return title;
                                },
                                afterTitle: function (context) {
                                    const index = context[0].dataIndex;
                                    const singleData = chartData.single_costs[index];
                                    return '\n' +
                                        'House Price: $' + singleData.schiller_price.toLocaleString() + '\n' +
                                        'Mortgage Rate: ' + singleData.mortgage_rate + '%\n' +
                                        'Total Cost: $' + singleData.total_cost.toLocaleString();
                                },
                                label: function (context) {
                                    const index = context.dataIndex;
                                    const isSingle = context.datasetIndex === 0;
                                    const data = isSingle ? chartData.single_costs[index] : chartData.household_costs[index];
                                    const incomeKey = isSingle ? 'single_income' : 'household_income';

                                    return [
                                        context.dataset.label + ':',
                                        '  Multiplier: ' + data.cost_to_income + 'x',
                                        '  Income: $' + data[incomeKey].toLocaleString()
                                    ];
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: null
                            },
                            limits: {
                                x: {
                                    min: 'original',
                                    max: 'original'
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                autoSkip: true
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Cost-to-Income Multiplier',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    onClick: function (event, activeElements) {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            updateInfoCards(index);
                        }
                    }
                },
                plugins: [estimatedRegionPlugin]
            });

            // Show latest data on load
            const latestIndex = chartData.single_costs.length - 1;
            updateInfoCards(latestIndex);
        }

        function resetZoom() {
            chartInstance.resetZoom();
        }

        function setDateRange(range) {
            const endDate = new Date(maxDate);
            let startDate = new Date(maxDate);

            switch (range) {
                case '1y':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
                case '2y':
                    startDate.setFullYear(endDate.getFullYear() - 2);
                    break;
                case '5y':
                    startDate.setFullYear(endDate.getFullYear() - 5);
                    break;
                case 'all':
                    startDate = new Date(minDate);
                    break;
            }

            // Find indices for the date range
            const startIndex = chartData.single_costs.findIndex(item => new Date(item.date) >= startDate);
            const endIndex = chartData.single_costs.findIndex(item => new Date(item.date) >= endDate);

            if (startIndex !== -1) {
                chartInstance.zoomScale('x', {
                    min: startIndex,
                    max: endIndex !== -1 ? endIndex : chartData.single_costs.length - 1
                });
            }
        }

        function updateInfoCards(index) {
            const singleData = chartData.single_costs[index];
            const householdData = chartData.household_costs[index];

            // Determine which dataset is currently visible
            const singleVisible = chartInstance.isDatasetVisible(0);
            const householdVisible = chartInstance.isDatasetVisible(1);

            let displayData, displayIncome;
            if (singleVisible && !householdVisible) {
                displayData = singleData;
                displayIncome = singleData.single_income;
            } else if (!singleVisible && householdVisible) {
                displayData = householdData;
                displayIncome = householdData.household_income;
            } else {
                displayData = householdData;
                displayIncome = householdData.household_income;
            }

            document.getElementById('currentMultiplier').textContent = displayData.cost_to_income + 'x';
            document.getElementById('housePrice').textContent = '$' + displayData.schiller_price.toLocaleString();
            document.getElementById('annualIncome').textContent = '$' + displayIncome.toLocaleString();
            document.getElementById('mortgageRate').textContent = displayData.mortgage_rate + '%';

            // Update card styling for estimated data
            const cards = ['multiplierCard', 'priceCard', 'incomeCard', 'rateCard'];
            const isEstimated = displayData.estimated || displayData.interpolated;

            cards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (isEstimated) {
                    card.classList.add('estimated');
                    if (!card.querySelector('.estimated-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'estimated-badge';
                        badge.textContent = displayData.estimated ? 'Estimated' : 'Interpolated';
                        card.appendChild(badge);
                    }
                } else {
                    card.classList.remove('estimated');
                    const badge = card.querySelector('.estimated-badge');
                    if (badge) badge.remove();
                }
            });
        }

        function showBothLines() {
            chartInstance.show(0);
            chartInstance.show(1);
            updateButtonStates(0);
            const latestIndex = chartData.single_costs.length - 1;
            updateInfoCards(latestIndex);
        }

        function showSingleOnly() {
            chartInstance.show(0);
            chartInstance.hide(1);
            updateButtonStates(1);
            const latestIndex = chartData.single_costs.length - 1;
            updateInfoCards(latestIndex);
        }

        function showHouseholdOnly() {
            chartInstance.hide(0);
            chartInstance.show(1);
            updateButtonStates(2);
            const latestIndex = chartData.single_costs.length - 1;
            updateInfoCards(latestIndex);
        }

        function updateButtonStates(activeIndex) {
            const buttons = document.querySelectorAll('.controls .btn');
            buttons.forEach((btn, index) => {
                if (index === activeIndex) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary', 'active');
                } else {
                    btn.classList.remove('btn-primary', 'active');
                    btn.classList.add('btn-secondary');
                }
            });
        }
    </script>
</body>

</html>